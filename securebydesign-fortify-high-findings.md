# Secure-by-Design Plan: Fortify HIGH remediation and report archiving

This Secure-by-Design plan follows `../.agent/SECURE.md` and covers remediation of Fortify HIGH findings plus capturing Fortify scan reports in Jenkins artifacts for rpx-xui-webapp.

## Purpose

Ensure Fortify scans for rpx-xui-webapp complete without HIGH severity issues while preserving secure handling of scan outputs and code changes, and ensure Fortify report artifacts are reliably archived in Jenkins for audit.

## Data and Secrets Handling

Fortify credentials remain in Azure Key Vault via the pipeline. No secrets are added to the repo. Any fixes avoid hard-coded secrets, maintain environment variable usage, and keep logs free of sensitive values.

## Logging and Artifacts

Fortify reports are generated by the Fortify client and archived by Jenkins. The pipeline and Gradle task staging copy the report into a workspace path that matches artifact collection, without printing report contents in logs. The Fortify API export writes `Fortify Scan/FortifyVulnerabilities.json` for per-issue details and merges results into any existing summary file. Reports are treated as sensitive code-security artifacts and only stored in CI artifacts.

## Network and Environment Safety

Changes add a Fortify API call after scans to export vulnerability details, using OAuth client credentials where configured. The Fortify client continues to run in CI with existing configuration and vault credentials. Local runs require approved Fortify credentials and should be done only in approved environments.

## Threats and Mitigations

- Secret leakage: avoid echoing environment variables or report contents; keep copying steps file-only.
- Over-broad scans or missing coverage: keep Fortify scan scope unchanged; do not alter source scan roots in the Gradle task.
- Supply-chain changes: do not change dependencies unless required by a specific finding; document any changes in the ExecPlan.

## Validation

Run the nightly pipeline or `yarn fortifyScan` in CI. Confirm the Fortify report is archived and the scan no longer fails for HIGH findings.

## Decision Log

- Decision: Copy Fortify report outputs into workspace root for artifact collection instead of changing Fortify scan working directory.
  Rationale: Avoids changing scan scope while satisfying Jenkins artifact patterns.
  Date/Author: 2026-01-14 / Codex.
- Decision: Stage Fortify config and report outputs in the Gradle `fortifyScan` task via helper tasks.
  Rationale: Ensures Jenkins archiving and Fortify metadata lookup can access artifacts even when the scan fails for HIGH findings.
  Date/Author: 2026-01-15 / Codex.
- Decision: Export Fortify vulnerabilities to JSON via a post-scan API call.
  Rationale: The default Fortify HTML report is summary-only; JSON enables mapping findings to source files.
  Date/Author: 2026-01-15 / Codex.
- Decision: Allow OAuth client credentials for Fortify API export and merge results into existing JSON.
  Rationale: Pipeline-produced summary files can omit issue details; merging preserves metadata while populating vulnerabilities.
  Date/Author: 2026-01-15 / Codex.

## Progress Notes

- 2026-01-14: Secure-by-Design plan created for Fortify remediation and report archiving.
- 2026-01-14: Jenkinsfile nightly stage updated to copy Fortify reports into the workspace root for safe archiving.
- 2026-01-15: Gradle Fortify task stages config and report outputs for reliable archiving and metadata lookup.
- 2026-01-15: Fortify API export writes `Fortify Scan/FortifyVulnerabilities.json` for detailed findings.
- 2026-01-15: Fortify API export updated to use OAuth credentials and merge results into existing JSON.
