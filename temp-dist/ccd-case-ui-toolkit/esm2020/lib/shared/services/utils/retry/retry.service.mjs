import { Injectable } from '@angular/core';
import { timer } from 'rxjs';
import { delayWhen, finalize, mergeMap, retryWhen, tap, timeout } from 'rxjs/operators';
import * as i0 from "@angular/core";
class ArtificialDelayContext {
    constructor(preferredDelay) {
        this.preferredDelay = preferredDelay;
        this.artificialDelayOn = true;
        this.selectedDelay = this.selectActualDelayTime();
    }
    ;
    switchArtificialDelays(status) {
        this.artificialDelayOn = status;
        this.selectedDelay = this.selectActualDelayTime();
    }
    turnOnArtificialDelays() {
        this.switchArtificialDelays(true);
    }
    turnOffArtificialDelays() {
        this.switchArtificialDelays(false);
    }
    getActualDelay() {
        return this.artificialDelayOn ? this.selectedDelay : 0;
    }
    shouldApplyArtificialDelay() {
        return this.preferredDelay > 0;
    }
    selectActualDelayTime() {
        return Date.now() % 2 == 0 ? this.preferredDelay : 1;
    }
}
export class RetryUtil {
    pipeTimeoutMechanismOn(in$, preferredArtificialDelay, timeoutPeriods) {
        const artificialDelayContext = new ArtificialDelayContext(preferredArtificialDelay);
        console.info(`Piping a retry mechanism with timeouts {${timeoutPeriods}}.`);
        console.info(`Artificial delay will be applied: ${artificialDelayContext.shouldApplyArtificialDelay()}.`);
        let out$ = in$;
        if (artificialDelayContext.shouldApplyArtificialDelay()) {
            console.info(`Preferred artificial delay: ${preferredArtificialDelay} seconds. Actual delay selected: ${artificialDelayContext.getActualDelay()}`);
            out$ = this.pipeArtificialDelayOn(out$, artificialDelayContext);
        }
        out$ = this.pipeTimeOutControlOn(out$, timeoutPeriods);
        out$ = this.pipeRetryMechanismOn(out$, artificialDelayContext);
        return out$;
    }
    pipeTimeOutControlOn(in$, timeoutPeriods) {
        const timeOutAfterSeconds = timeoutPeriods[0];
        console.info(`Piping timeout control with ${timeOutAfterSeconds} seconds.`);
        const out$ = in$.pipe(timeout(timeOutAfterSeconds * 1000));
        return out$;
    }
    pipeRetryMechanismOn(in$, artificialDelayContext) {
        const retryStrategy = (errors) => {
            return errors.pipe(mergeMap((error, i) => {
                console.error(`Mapping error ${error?.name}, ${i}`);
                console.error(error);
                if (error?.name === 'TimeoutError' && i === 0) {
                    artificialDelayContext.turnOffArtificialDelays();
                    console.info('Will retry, after a timeout error.');
                }
                else {
                    console.error('Will NOT retry.');
                    throw error;
                }
                return timer(0);
            }), finalize(() => console.log('We are done!')));
        };
        const out$ = in$.pipe(retryWhen(retryStrategy));
        return out$;
    }
    pipeArtificialDelayOn(in$, artificialDelayContext) {
        let out$ = in$.pipe(tap(() => {
            console.log(`Artificially delaying for ${artificialDelayContext.getActualDelay()} seconds..`);
        }));
        out$ = out$.pipe(delayWhen(() => timer(artificialDelayContext.getActualDelay() * 1000)));
        out$ = out$.pipe(tap(() => {
            console.log(`Artificially delayed for ${artificialDelayContext.getActualDelay()} seconds..`);
        }));
        return out$;
    }
}
RetryUtil.ɵfac = function RetryUtil_Factory(t) { return new (t || RetryUtil)(); };
RetryUtil.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: RetryUtil, factory: RetryUtil.ɵfac });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(RetryUtil, [{
        type: Injectable
    }], null, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV0cnkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NjZC1jYXNlLXVpLXRvb2xraXQvc3JjL2xpYi9zaGFyZWQvc2VydmljZXMvdXRpbHMvcmV0cnkvcmV0cnkuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBMEIsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxNQUFNLGdCQUFnQixDQUFDOztBQUV4RixNQUFNLHNCQUFzQjtJQUd4QixZQUNZLGNBQXNCO1FBQXRCLG1CQUFjLEdBQWQsY0FBYyxDQUFRO1FBSDFCLHNCQUFpQixHQUFHLElBQUksQ0FBQztRQUN6QixrQkFBYSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBSXJELENBQUM7SUFKb0QsQ0FBQztJQUsvQyxzQkFBc0IsQ0FBQyxNQUFlO1FBQ3pDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUM7UUFDaEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUN0RCxDQUFDO0lBQ00sc0JBQXNCO1FBQ3pCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU0sdUJBQXVCO1FBQzFCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBQ00sY0FBYztRQUNqQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFTSwwQkFB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QixDQUFDO0lBRU8scUJBQXFCLENBQUksR0FBa0IsRUFBRSxzQkFBOEM7UUFDL0YsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ3pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLHNCQUFzQixDQUFDLGNBQWMsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNsRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ0osSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxjQUFjLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekYsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUE0QixzQkFBc0IsQ0FBQyxjQUFjLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDakcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNKLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7O2tFQXREUSxTQUFTOytEQUFULFNBQVMsV0FBVCxTQUFTO3VGQUFULFNBQVM7Y0FEckIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIHRocm93RXJyb3IsIHRpbWVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWxheVdoZW4sIGZpbmFsaXplLCBtZXJnZU1hcCwgcmV0cnlXaGVuLCB0YXAsIHRpbWVvdXQgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmNsYXNzIEFydGlmaWNpYWxEZWxheUNvbnRleHQge1xuICAgIHByaXZhdGUgYXJ0aWZpY2lhbERlbGF5T24gPSB0cnVlO1xuICAgIHByaXZhdGUgc2VsZWN0ZWREZWxheSA9IHRoaXMuc2VsZWN0QWN0dWFsRGVsYXlUaW1lKCk7O1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHByZWZlcnJlZERlbGF5OiBudW1iZXJcbiAgICApIHtcbiAgICB9XG4gICAgcHVibGljIHN3aXRjaEFydGlmaWNpYWxEZWxheXMoc3RhdHVzOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuYXJ0aWZpY2lhbERlbGF5T24gPSBzdGF0dXM7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWREZWxheSA9IHRoaXMuc2VsZWN0QWN0dWFsRGVsYXlUaW1lKCk7XG4gICAgfVxuICAgIHB1YmxpYyB0dXJuT25BcnRpZmljaWFsRGVsYXlzKCkge1xuICAgICAgICB0aGlzLnN3aXRjaEFydGlmaWNpYWxEZWxheXModHJ1ZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHR1cm5PZmZBcnRpZmljaWFsRGVsYXlzKCkge1xuICAgICAgICB0aGlzLnN3aXRjaEFydGlmaWNpYWxEZWxheXMoZmFsc2UpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0QWN0dWFsRGVsYXkoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFydGlmaWNpYWxEZWxheU9uID8gdGhpcy5zZWxlY3RlZERlbGF5IDogMDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvdWxkQXBwbHlBcnRpZmljaWFsRGVsYXkoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByZWZlcnJlZERlbGF5ID4gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNlbGVjdEFjdHVhbERlbGF5VGltZSgpIHtcbiAgICAgICAgcmV0dXJuIERhdGUubm93KCkgJSAyID09IDAgPyB0aGlzLnByZWZlcnJlZERlbGF5IDogMTtcbiAgICB9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSZXRyeVV0aWwge1xuICAgIHB1YmxpYyBwaXBlVGltZW91dE1lY2hhbmlzbU9uPFQ+KGluJDogT2JzZXJ2YWJsZTxUPiwgcHJlZmVycmVkQXJ0aWZpY2lhbERlbGF5OiBudW1iZXIsIHRpbWVvdXRQZXJpb2RzOiBudW1iZXJbXSk6IE9ic2VydmFibGU8VD4ge1xuICAgICAgICBjb25zdCBhcnRpZmljaWFsRGVsYXlDb250ZXh0ID0gbmV3IEFydGlmaWNpYWxEZWxheUNvbnRleHQocHJlZmVycmVkQXJ0aWZpY2lhbERlbGF5KTtcbiAgICAgICAgY29uc29sZS5pbmZvKGBQaXBpbmcgYSByZXRyeSBtZWNoYW5pc20gd2l0aCB0aW1lb3V0cyB7JHt0aW1lb3V0UGVyaW9kc319LmApO1xuICAgICAgICBjb25zb2xlLmluZm8oYEFydGlmaWNpYWwgZGVsYXkgd2lsbCBiZSBhcHBsaWVkOiAke2FydGlmaWNpYWxEZWxheUNvbnRleHQuc2hvdWxkQXBwbHlBcnRpZmljaWFsRGVsYXkoKX0uYCk7XG5cbiAgICAgICAgbGV0IG91dCQgPSBpbiQ7XG4gICAgICAgIGlmIChhcnRpZmljaWFsRGVsYXlDb250ZXh0LnNob3VsZEFwcGx5QXJ0aWZpY2lhbERlbGF5KCkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhgUHJlZmVycmVkIGFydGlmaWNpYWwgZGVsYXk6ICR7cHJlZmVycmVkQXJ0aWZpY2lhbERlbGF5fSBzZWNvbmRzLiBBY3R1YWwgZGVsYXkgc2VsZWN0ZWQ6ICR7YXJ0aWZpY2lhbERlbGF5Q29udGV4dC5nZXRBY3R1YWxEZWxheSgpfWApO1xuICAgICAgICAgICAgb3V0JCA9IHRoaXMucGlwZUFydGlmaWNpYWxEZWxheU9uKG91dCQsIGFydGlmaWNpYWxEZWxheUNvbnRleHQpO1xuICAgICAgICB9XG4gICAgICAgIG91dCQgPSB0aGlzLnBpcGVUaW1lT3V0Q29udHJvbE9uKG91dCQsIHRpbWVvdXRQZXJpb2RzKTtcbiAgICAgICAgb3V0JCA9IHRoaXMucGlwZVJldHJ5TWVjaGFuaXNtT24ob3V0JCwgYXJ0aWZpY2lhbERlbGF5Q29udGV4dCk7XG4gICAgICAgIHJldHVybiBvdXQkO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGlwZVRpbWVPdXRDb250cm9sT248VD4oaW4kOiBPYnNlcnZhYmxlPFQ+LCB0aW1lb3V0UGVyaW9kczogbnVtYmVyW10pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICAgICAgY29uc3QgdGltZU91dEFmdGVyU2Vjb25kcyA9IHRpbWVvdXRQZXJpb2RzWzBdO1xuICAgICAgICBjb25zb2xlLmluZm8oYFBpcGluZyB0aW1lb3V0IGNvbnRyb2wgd2l0aCAke3RpbWVPdXRBZnRlclNlY29uZHN9IHNlY29uZHMuYCk7XG4gICAgICAgIGNvbnN0IG91dCQgPSBpbiQucGlwZSh0aW1lb3V0KHRpbWVPdXRBZnRlclNlY29uZHMgKiAxMDAwKSk7XG4gICAgICAgIHJldHVybiBvdXQkO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGlwZVJldHJ5TWVjaGFuaXNtT248VD4oaW4kOiBPYnNlcnZhYmxlPFQ+LCBhcnRpZmljaWFsRGVsYXlDb250ZXh0OiBBcnRpZmljaWFsRGVsYXlDb250ZXh0KTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgICAgIGNvbnN0IHJldHJ5U3RyYXRlZ3kgPSAoZXJyb3JzKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZXJyb3JzLnBpcGUoXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAoKGVycm9yOiBFcnJvciwgaSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBNYXBwaW5nIGVycm9yICR7ZXJyb3I/Lm5hbWV9LCAke2l9YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3I/Lm5hbWUgPT09ICdUaW1lb3V0RXJyb3InICYmIGkgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFydGlmaWNpYWxEZWxheUNvbnRleHQudHVybk9mZkFydGlmaWNpYWxEZWxheXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbygnV2lsbCByZXRyeSwgYWZ0ZXIgYSB0aW1lb3V0IGVycm9yLicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignV2lsbCBOT1QgcmV0cnkuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGltZXIoMCk7XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgZmluYWxpemUoKCkgPT4gY29uc29sZS5sb2coJ1dlIGFyZSBkb25lIScpKSk7XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IG91dCQgPSBpbiQucGlwZShyZXRyeVdoZW4ocmV0cnlTdHJhdGVneSkpO1xuICAgICAgICByZXR1cm4gb3V0JDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBpcGVBcnRpZmljaWFsRGVsYXlPbjxUPihpbiQ6IE9ic2VydmFibGU8VD4sIGFydGlmaWNpYWxEZWxheUNvbnRleHQ6IEFydGlmaWNpYWxEZWxheUNvbnRleHQpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICAgICAgbGV0IG91dCQgPSBpbiQucGlwZSh0YXAoKCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYEFydGlmaWNpYWxseSBkZWxheWluZyBmb3IgJHthcnRpZmljaWFsRGVsYXlDb250ZXh0LmdldEFjdHVhbERlbGF5KCl9IHNlY29uZHMuLmApO1xuICAgICAgICB9KSk7XG4gICAgICAgIG91dCQgPSBvdXQkLnBpcGUoZGVsYXlXaGVuKCgpID0+IHRpbWVyKGFydGlmaWNpYWxEZWxheUNvbnRleHQuZ2V0QWN0dWFsRGVsYXkoKSAqIDEwMDApKSk7XG4gICAgICAgIG91dCQgPSBvdXQkLnBpcGUodGFwKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBBcnRpZmljaWFsbHkgZGVsYXllZCBmb3IgJHthcnRpZmljaWFsRGVsYXlDb250ZXh0LmdldEFjdHVhbERlbGF5KCl9IHNlY29uZHMuLmApO1xuICAgICAgICB9KSk7XG4gICAgICAgIHJldHVybiBvdXQkO1xuICAgIH1cbn1cbiJdfQ==